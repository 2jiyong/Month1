# HEAP메모리

## 설계하기
### heap 객체
heap 객체 안에는 heap에게 할당된 총 메모리가 있다. 
heap 객체를 선언할때 base 메모리를 설정하도록 했다.  
그리고 이제 init을 하면 실제로 사용할 수 있는 메모리가 결정되고 base 메모리 주소를 반환한다.  
실제로 사용할 메모리는 배열로 구현하고, 배열 한 칸을 한 바이트라고 생각한다.  

heap 객체에는 malloc을 통해 여러 블록들이 추가된다.  
맨 처음 init을 하면 heap전체가 하나의 큰 free 블록이 된다.  
malloc을 실행하며 여러 블록으로 나뉘게 된다.  

각 블록의 맨 처음에는 heap의 메타데이터가 포함되어야 한다.  
메타데이터에는 블록의 크기, 타입, 할당여부가 포함된다.  
구현하면서 블록의 메타데이터엔 이전, 이후 블록의 시작 offset을 포함하는 것이 필요하다고 느꼈다. 
메타데이터 역시 8의 배수여야했고, 많은 정보가 필요 없기에 그냥 8바이트로 설정했다.  
### setSize
setSize는 단순히 그냥 map으로서 고유한 사이즈를 지정하고, typeSizeMap과 typeIdMap을 통해 관리한다.  
새로운 type을 추가할 때마다 map에 추가한다.  
### malloc
블록에는 우선 메타데이터가 있다. 메타데이터에는 블록의 크기와 할당여부, 현재 블록의 타입이 있다.  
배열을 확보하기 위해 메모리를 읽으면, 우선 메타데이터를 처음 읽게 된다.  

malloc을 하면 우선 배열을 확보해야한다.
heap의 시작에서부터 빈칸이 있는지를 확인하고, 빈칸이 있다면 그 빈칸을 할당한다.  
메타데이터를 읽어, 현재 블록이 할당이 가능하다면, 할당을하고, 아니라면 블록의 사이즈만큼 넘어가, 다음 메타데이터로 넘어가게된다.
할당한 후, 이후의 메타데이터를 만들어준다. 기존의 블록을 두개로 나눈다고 생각.
그렇게 하기 위해선 기존의 메타데이터를 기반으로 두번째 메타데이터를 만들어주면 된다.
### free 
할당된 블록을 할당 해제한다.  
isAllocated를 0으로 변경하고, 이전과 이후의 블록이 이미 할당 해제되어 있다면 그 블록들과 합쳐준다.

## 메타데이터 양식
1칸은 size,
1칸은 할당여부,
1칸은 타입,
5칸은 padding